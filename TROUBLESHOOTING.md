# iChat é—®é¢˜è¯Šæ–­å’Œä¿®å¤

## ğŸ› å½“å‰é—®é¢˜

### é—®é¢˜ 1: åœ¨çº¿çŠ¶æ€æ˜¾ç¤ºä¸ä¸€è‡´
**ç°è±¡**: Kevinæ˜¾ç¤ºåœ¨çº¿ï¼ŒPeteræ˜¾ç¤ºç¦»çº¿ï¼ˆä½†å®é™…éƒ½åœ¨çº¿ï¼‰

**å¯èƒ½åŸå› **:
1. å¥½å‹åˆ—è¡¨åŠ è½½æ—¶çŠ¶æ€æœªæ›´æ–°
2. Socketä¸Šçº¿é€šçŸ¥æœªæ­£ç¡®å‘é€/æ¥æ”¶
3. çŠ¶æ€å­—æ®µæœªæ­£ç¡®åŒæ­¥

### é—®é¢˜ 2: å•å‘æ¶ˆæ¯å‘é€
**ç°è±¡**: åªèƒ½Peter â†’ Kevinå‘æ¶ˆæ¯ï¼ŒKevin â†’ Peterå‘ä¸äº†

**å¯èƒ½åŸå› **:
1. å¥½å‹å…³ç³»ä¸å¯¹ç§°
2. Socketæƒé™éªŒè¯é—®é¢˜
3. æ¶ˆæ¯å‘é€é€»è¾‘é”™è¯¯

### é—®é¢˜ 3: çº¢ç‚¹é€šçŸ¥ä¸å®æ—¶
**ç°è±¡**: Peterå‘æ¶ˆæ¯ï¼ŒKevinæ²¡æœ‰å®æ—¶çº¢ç‚¹

**å¯èƒ½åŸå› **:
1. Socketæ¥æ”¶æ¶ˆæ¯äº‹ä»¶æœªè§¦å‘
2. æœªè¯»è®¡æ•°é€»è¾‘æœªæ‰§è¡Œ
3. UIæœªåˆ·æ–°

---

## ğŸ” è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1: æ£€æŸ¥å¥½å‹å…³ç³»

æ‰“å¼€MongoDB shellæˆ–ä½¿ç”¨MongoDB Compassï¼š

```javascript
// æ£€æŸ¥Kevinçš„å¥½å‹åˆ—è¡¨
db.users.findOne({username: "Kevin"}, {friends: 1, username: 1})

// æ£€æŸ¥Peterçš„å¥½å‹åˆ—è¡¨
db.users.findOne({username: "Peter"}, {friends: 1, username: 1})

// ä¸¤è€…çš„friendsæ•°ç»„åº”è¯¥äº’ç›¸åŒ…å«å¯¹æ–¹çš„_id
```

**é¢„æœŸç»“æœ**: 
- Kevin.friends åŒ…å« Peter._id
- Peter.friends åŒ…å« Kevin._id

### æ­¥éª¤ 2: æ£€æŸ¥Socketè¿æ¥

åœ¨Flutteråº”ç”¨çš„æ§åˆ¶å°ä¸­æŸ¥çœ‹ï¼š

```
âœ… Socket å·²è¿æ¥
ç”¨æˆ·è¿æ¥: Kevin (xxx)
ç”¨æˆ·è¿æ¥: Peter (xxx)
```

### æ­¥éª¤ 3: æµ‹è¯•æ¶ˆæ¯å‘é€

1. Peterå‘æ¶ˆæ¯ç»™Kevin
2. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼š
   - Kevinç«¯åº”è¯¥æ˜¾ç¤º: `æ”¶åˆ°æ¶ˆæ¯ï¼Œå¢åŠ æœªè¯»: fromId=xxx`
   - æœåŠ¡å™¨åº”è¯¥æ˜¾ç¤º: æ¶ˆæ¯å‘é€ç¡®è®¤

3. Kevinå‘æ¶ˆæ¯ç»™Peter
   - æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
   - æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: ç¡®ä¿å¥½å‹å…³ç³»å¯¹ç§°

å¦‚æœå¥½å‹å…³ç³»ä¸å¯¹ç§°ï¼Œåœ¨MongoDBä¸­æ‰‹åŠ¨ä¿®å¤ï¼š

```javascript
// è·å–ç”¨æˆ·ID
const kevin = db.users.findOne({username: "Kevin"})
const peter = db.users.findOne({username: "Peter"})

// ç¡®ä¿åŒå‘å¥½å‹å…³ç³»
db.users.updateOne(
  {_id: kevin._id},
  {$addToSet: {friends: peter._id}}
)

db.users.updateOne(
  {_id: peter._id},
  {$addToSet: {friends: kevin._id}}
)
```

### ä¿®å¤ 2: é‡æ–°å»ºç«‹å¥½å‹å…³ç³»

**å»ºè®®æµç¨‹**:
1. åˆ é™¤ç°æœ‰å¥½å‹å…³ç³»
2. é‡æ–°å‘é€å¥½å‹è¯·æ±‚
3. æ¥å—å¥½å‹è¯·æ±‚
4. éªŒè¯åŒæ–¹éƒ½èƒ½çœ‹åˆ°å¯¹æ–¹

### ä¿®å¤ 3: æ£€æŸ¥å®¢æˆ·ç«¯åˆå§‹åŒ–

ç¡®ä¿èŠå¤©Provideræ­£ç¡®åˆå§‹åŒ–ï¼š

```dart
// åœ¨ splash_screen.dart ä¸­
if (isAuthenticated) {
  chatProvider.initialize();  // âœ… å¿…é¡»è°ƒç”¨
  await chatProvider.loadFriends();  // âœ… åŠ è½½å¥½å‹åˆ—è¡¨
  await chatProvider.loadFriendRequests();
  await chatProvider.loadUnreadCount();
}
```

---

## ğŸ“‹ å®Œæ•´æµ‹è¯•æµç¨‹

### åœºæ™¯ 1: æ–°ç”¨æˆ·å®Œæ•´æµç¨‹

```
1. æ³¨å†Œè´¦æˆ·A (Kevin)
2. æ³¨å†Œè´¦æˆ·B (Peter)
3. Aæœç´¢å¹¶æ·»åŠ Bä¸ºå¥½å‹
4. Bæ¥å—å¥½å‹è¯·æ±‚
5. éªŒè¯:
   âœ… Açš„å¥½å‹åˆ—è¡¨æ˜¾ç¤ºBï¼ˆåœ¨çº¿ï¼‰
   âœ… Bçš„å¥½å‹åˆ—è¡¨æ˜¾ç¤ºAï¼ˆåœ¨çº¿ï¼‰
6. Aç»™Bå‘æ¶ˆæ¯
7. éªŒè¯:
   âœ… Bç«‹å³æ”¶åˆ°æ¶ˆæ¯
   âœ… Bçš„åº•éƒ¨å¯¼èˆªæ˜¾ç¤ºçº¢ç‚¹ "1"
8. Bæ‰“å¼€èŠå¤©
9. éªŒè¯:
   âœ… çº¢ç‚¹æ¶ˆå¤±
   âœ… æ¶ˆæ¯æ˜¾ç¤ºæ­£ç¡®
10. Bç»™Aå›å¤
11. éªŒè¯:
    âœ… Aç«‹å³æ”¶åˆ°æ¶ˆæ¯
    âœ… Aæ˜¾ç¤ºçº¢ç‚¹
```

### åœºæ™¯ 2: ç°æœ‰ç”¨æˆ·ä¿®å¤

å¦‚æœæ˜¯ç°æœ‰çš„Kevinå’ŒPeterè´¦æˆ·æœ‰é—®é¢˜ï¼š

```
é€‰é¡¹A: æ¸…ç†å¹¶é‡å»º
1. é€€å‡ºæ‰€æœ‰ç™»å½•
2. åˆ é™¤æ•°æ®åº“ä¸­çš„ç”¨æˆ·æ•°æ®
3. é‡æ–°æ³¨å†Œ
4. æŒ‰ç…§åœºæ™¯1æµ‹è¯•

é€‰é¡¹B: ä¿®å¤ç°æœ‰æ•°æ®
1. ä½¿ç”¨MongoDBä¿®å¤å¥½å‹å…³ç³»ï¼ˆè§ä¿®å¤1ï¼‰
2. é‡å¯æœåŠ¡å™¨
3. é‡æ–°ç™»å½•
4. æµ‹è¯•åŠŸèƒ½
```

---

## ğŸ”§ è°ƒè¯•å‘½ä»¤

### æœåŠ¡å™¨ç«¯

```bash
# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
cd /Users/Adam/Documents/ideas/ichat/server
npm start

# åº”è¯¥çœ‹åˆ°:
# ğŸš€ iChat æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ 3000
# âœ… MongoDB è¿æ¥æˆåŠŸ
# ç”¨æˆ·è¿æ¥: Kevin (xxx)
# ç”¨æˆ·è¿æ¥: Peter (xxx)
```

### å®¢æˆ·ç«¯

åœ¨Flutteråº”ç”¨æ§åˆ¶å°ä¸­æŸ¥çœ‹ï¼š

```
# Socketè¿æ¥
âœ… Socket å·²è¿æ¥

# æ”¶åˆ°æ¶ˆæ¯
æ”¶åˆ°æ¶ˆæ¯ï¼Œå¢åŠ æœªè¯»: fromId=xxx, è¯¥ç”¨æˆ·æœªè¯»=1, æ€»æœªè¯»=1

# æ‰“å¼€èŠå¤©
è®¾ç½®å½“å‰èŠå¤©ç”¨æˆ·: null -> xxx
æ¸…é™¤æœªè¯»è®¡æ•°: userId=xxx, count=1, æ€»æœªè¯»æ•°=1
æ¸…é™¤å: æ€»æœªè¯»æ•°=0
```

---

## ğŸ’¡ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œå¯ä»¥å°è¯•ï¼š

### æ–¹æ¡ˆ 1: å®Œå…¨é‡ç½®

```bash
# 1. åœæ­¢æœåŠ¡å™¨
pkill -f "node.*src/index.js"

# 2. æ¸…ç©ºæ•°æ®åº“
mongo ichat --eval "db.dropDatabase()"

# 3. é‡å¯æœåŠ¡å™¨
cd /Users/Adam/Documents/ideas/ichat/server
npm start

# 4. å®¢æˆ·ç«¯é‡æ–°å®‰è£…
cd /Users/Adam/Documents/ideas/ichat/client
flutter clean
flutter pub get
flutter run -d macos
```

### æ–¹æ¡ˆ 2: ä½¿ç”¨æ–°è´¦æˆ·æµ‹è¯•

åˆ›å»ºä¸¤ä¸ªå…¨æ–°çš„è´¦æˆ·ï¼ˆä¾‹å¦‚ï¼šAliceå’ŒBobï¼‰æ¥æµ‹è¯•æ‰€æœ‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆä»¥ä¸‹æ‰€æœ‰æ£€æŸ¥ï¼š

- [ ] æœåŠ¡å™¨æ­£å¸¸è¿è¡Œï¼ˆç«¯å£3000ï¼‰
- [ ] MongoDBå·²è¿æ¥
- [ ] ä¸¤ä¸ªç”¨æˆ·éƒ½èƒ½ç™»å½•
- [ ] Socketè¿æ¥æ˜¾ç¤º "âœ… Socket å·²è¿æ¥"
- [ ] å¥½å‹å…³ç³»å¯¹ç§°ï¼ˆäº’ç›¸éƒ½åœ¨å¥½å‹åˆ—è¡¨ä¸­ï¼‰
- [ ] åŒæ–¹éƒ½æ˜¾ç¤ºæ­£ç¡®çš„åœ¨çº¿çŠ¶æ€
- [ ] Aèƒ½ç»™Bå‘æ¶ˆæ¯
- [ ] Bèƒ½ç»™Aå‘æ¶ˆæ¯
- [ ] æ”¶åˆ°æ¶ˆæ¯æ—¶æ˜¾ç¤ºçº¢ç‚¹
- [ ] æ‰“å¼€èŠå¤©æ—¶çº¢ç‚¹æ¶ˆå¤±
- [ ] èŠå¤©ä¸­æ”¶æ¶ˆæ¯ä¸æ˜¾ç¤ºçº¢ç‚¹

---

## ğŸ†˜ å¦‚æœè¿˜æ˜¯ä¸è¡Œ

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æœåŠ¡å™¨æ—¥å¿—** - å®Œæ•´çš„å¯åŠ¨å’Œè¿è¡Œæ—¥å¿—
2. **å®¢æˆ·ç«¯æ—¥å¿—** - Flutteræ§åˆ¶å°çš„å®Œæ•´è¾“å‡º
3. **MongoDBæ•°æ®** - Kevinå’ŒPeterçš„friendsæ•°ç»„å†…å®¹
4. **å…·ä½“æ“ä½œ** - è¯¦ç»†æè¿°ä½ åšäº†ä»€ä¹ˆï¼Œå‘ç”Ÿäº†ä»€ä¹ˆ

---

## ğŸ“ å¿«é€Ÿæµ‹è¯•å‘½ä»¤

```bash
# ç»ˆç«¯1: å¯åŠ¨æœåŠ¡å™¨
cd /Users/Adam/Documents/ideas/ichat/server
npm start

# ç»ˆç«¯2: è¿è¡Œå®¢æˆ·ç«¯1 (Kevin)
cd /Users/Adam/Documents/ideas/ichat/client
flutter run -d macos

# ç»ˆç«¯3: è¿è¡Œå®¢æˆ·ç«¯2 (Peter) - å¦‚æœæœ‰iOSæ¨¡æ‹Ÿå™¨
cd /Users/Adam/Documents/ideas/ichat/client
flutter run -d ios
```

è¿™æ ·å¯ä»¥åœ¨åŒä¸€å°ç”µè„‘ä¸ŠåŒæ—¶æµ‹è¯•ä¸¤ä¸ªè´¦æˆ·ï¼
